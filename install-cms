#!/bin/bash

# Use it :
# ./install-cms ./my-folder

# Bash script relative lines
: ${1?failure: in wich folder should i work ?}
folder=$1
echo "Installation running in folder $folder"

# First clean the folder where we will install
rm -rf ${folder}

# Install symfony
composer create-project symfony/skeleton ${folder} ^4.4
cd ${folder}

# Install Pied Web CMS
composer require piedweb/cms-bundle ^0

# Work around because we prepend our config in the bundle
#sed -i -e "/access_control:/d" ./config/packages/security.yaml
sed -i -e "/PiedWeb\\\CMSBundle\\\PiedWebCMSBundle::class => \['all' => true\],/d" config/bundles.php
sed -i -e "s/return \[/return \[\n    PiedWeb\\\CMSBundle\\\PiedWebCMSBundle::class => \['all' => true\],/" config/bundles.php
# Set in french :)
sed -i -e "s/parameters:/parameters:\n    locale: 'fr'/" config/services.yaml
# We erase all configuration files generated by recipes and copy ours
#   Old Way : cp -R vendor/piedweb/cms-bundle/src/Resources/config/packages/. config/packages/
#   New Way : symlinking piedweb/cms config files
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/doctrine.yaml config/packages/doctrine.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/framework.yaml config/packages/framework.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/liip_imagine.yaml config/packages/liip_imagine.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/security.yaml config/packages/security.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/sonata_admin.yaml config/packages/sonata_admin.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/sonata_translation.yaml config/packages/sonata_translation.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/sonata_translation.yaml config/packages/sonata_translation.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/translation.yaml config/packages/translation.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/twig.yaml config/packages/twig.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/vich_uploader.yaml config/packages/vich_uploader.yaml
ln -s -f ../../vendor/piedweb/cms-bundle/src/Resources/config/packages/fos_user.yaml config/packages/fos_user.yaml
#   We copu piedweb_cms config to easily edit it later manually
cp vendor/piedweb/cms-bundle/src/Resources/config/packages/piedweb_cms.yaml config/packages/piedweb_cms.yaml

rm config/packages/sonata_translation.yaml
php bin/console cache:clear

# Create default Entity
mkdir src/Entity
cp -R vendor/piedweb/cms-bundle/Install/Entity/. src/Entity

# Install web server to test
composer require symfony/web-server-bundle --dev

# Copy assets
mkdir -p assets
cp vendor/piedweb/cms-bundle/assets/.babelrc .babelrc
cp vendor/piedweb/cms-bundle/assets/package.json package.json
cp vendor/piedweb/cms-bundle/assets/webpack.config.js webpack.config.js
cp vendor/piedweb/cms-bundle/assets/main.js assets/main.js
cp vendor/piedweb/cms-bundle/assets/main.scss assets/main.scss
cp -r vendor/piedweb/cms-bundle/assets/icons assets/

# Create favicon
convert -background none assets/icons/icon.svg -define icon:auto-resize=16,32,48 assets/icons/favicon.ico
# Advice
# use https://realfavicongenerator.net and erase in `templates/bundles/PiedWebCMSBundle/base.html.twig` `favicon` block

# Install assets for the default theme
yarn
yarn encore dev

# Install sqlite by default
sed -i -e "s/mysql:\/\/db_user:db_password@127\.0\.0\.1:3306\/db_name/\"sqlite:\/\/\/%kernel\.project_dir%\/var\/app\.db\"/" .env

## Install default routes
cp -f vendor/piedweb/cms-bundle/src/Resources/config/routes/all.yaml config/routes.yaml

## Install static bundle
composer require piedweb/static-bundle ^0
sed -i -e "s/admin:/static:\n    resource: '@PiedWebStaticBundle\/Resources\/config\/routes\/static.yaml'\n\nadmin:/" config/routes.yaml


# Create Database:
php bin/console doctrine:schema:create

# Add an admin user :
read -p 'Email: ' emailvar
read -sp 'Password: ' passvar
php bin/console fos:user:create $emailvar $emailvar $passvar
php bin/console fos:user:promote $emailvar ROLE_SUPER_ADMIN

# Install Sonata Front-End Assets
php bin/console assets:install

# Create a robots.txt
echo '' >public/robots.txt

# Launch Server and Play
php bin/console server:run
